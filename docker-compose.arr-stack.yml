
#####################################################################
# ⚠️  NEVER use 'docker compose down' - kills Pi-hole DNS!        #
# ⚠️  You WILL lose internet before you can run 'up -d'           #
#                                                                   #
# ✅ Safe restart: docker compose -f docker-compose.arr-stack.yml up -d --force-recreate
# ✅ Or use:       ./scripts/restart-stack.sh                      #
#####################################################################

#########################
# Networks              #
#########################
networks:
  vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.1.0/24
  arr-stack:
    external: true
    # name: arr-stack
    # driver: bridge
    # ipam:
    #   config:
    #     - subnet: 172.20.0.0/24
    #       ip_range: 172.20.0.128/25
    #       gateway: 172.20.0.1

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  # ═══════════════════════════════════════════════════════════════════════════
  # GLUETUN - VPN gateway. Routes download traffic through your VPN provider.
  # All services below marked "via VPN" share this network for privacy.
  # ═══════════════════════════════════════════════════════════════════════════
  gluetun:
    image: qmcgaw/gluetun:v3.41
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ${CONFIG_ROOT}/gluetun:/gluetun
    environment:
      # VPN Configuration - see .env.example for provider-specific setup
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=${VPN_COUNTRIES}
      - TZ=${TZ}
      - DNS_ADDRESS=1.1.1.1
      - FIREWALL_OUTBOUND_SUBNETS=${LAN_SUBNET},172.20.0.0/24,10.8.1.0/24
    ports:
      # Ports for services using network_mode: "service:gluetun"
      # Enables direct local access without Traefik (http://NAS_IP:PORT)
      - "8989:8989"   # Sonarr
      - "7878:7878"   # Radarr
      - "8686:8686"   # Lidarr
      - "5299:5299"   # Lazylibrarian
      - "9696:9696"   # Prowlarr
      - "8085:8085"   # qBittorrent
      - "8191:8191"   # FlareSolverr
    networks:
      arr-stack:
        ipv4_address: 172.20.0.3
      vpn-net:
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s  # Give VPN time to establish connection

  # ═══════════════════════════════════════════════════════════════════════════
  # QBITTORRENT - Torrent download client. Downloads files through VPN.
  # Access: qbit.mediastack.lab | qbit.yourdomain.com | NAS_IP:8085
  # ═══════════════════════════════════════════════════════════════════════════
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - ${CONFIG_ROOT}/qbittorrent:/config
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8085/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # SONARR - TV show monitor. Watches for new episodes and sends to download.
  # Access: sonarr.mediastack.lab | sonarr.yourdomain.com | NAS_IP:8989
  # ═══════════════════════════════════════════════════════════════════════════
  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.16
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/sonarr:/config
      - ${MEDIA_ROOT}/tv:/tv
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8989/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # PROWLARR - Indexer manager. Finds download sources for Sonarr/Radarr.
  # Access: prowlarr.mediastack.lab | prowlarr.yourdomain.com | NAS_IP:9696
  # ═══════════════════════════════════════════════════════════════════════════
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:2.3.0
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/prowlarr:/config
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9696/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # RADARR - Movie monitor. Watches for new movies and sends to download.
  # Access: radarr.mediastack.lab | radarr.yourdomain.com | NAS_IP:7878
  # ═══════════════════════════════════════════════════════════════════════════
  radarr:
    image: lscr.io/linuxserver/radarr:6.0.4
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/radarr:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7878/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # PLEX - Media server. Stream your movies and TV shows like Netflix.
  # Access: plex.mediastack.lab | plex.yourdomain.com | NAS_IP:32400
  # ═══════════════════════════════════════════════════════════════════════════
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
      - HOSTNAME=plex.mediastack.lab
      - ADVERTISE_IP=http://${NAS_IP},http://192.168.1.102
    volumes:
      - ${CONFIG_ROOT}/plex:/config
      - ${CONFIG_ROOT}/plex-transcode:/transcode
      - ${MEDIA_ROOT}/tv:/tv
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/music:/music
    ports:
      - "80:32400"   # Web UI
      - "1900:1900/udp" # DLNA
      - "8324:8324"     # Plex Companion (remote control)
      - "32410:32410/udp" # GDM network discovery
      - "32412:32412/udp" # GDM network discovery
      - "32413:32413/udp" # GDM network discovery
      - "32414:32414/udp" # GDM network discovery
      - "32469:32469"   # Plex DLNA
    networks:
      arr-stack:
        ipv4_address: 172.20.0.4
        traefik-lan:
          ipv4_address: 192.168.1.102
          mac_address: "02:42:c0:a8:01:66"
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "--connect-timeout", "15", "--silent", "--show-error", "--fail", "http://localhost:32400/identity"]
      interval: 1m
      timeout: 30s
      retries: 2
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # SEERR (formerly Jellyseerr) - Request portal. Users request movies/shows here.
  # Access: seerr.mediastack.lab | seerr.yourdomain.com | NAS_IP:5055
  # ═══════════════════════════════════════════════════════════════════════════
  seerr:
    image: ghcr.io/seerr-team/seerr:v3.0.1
    init: true
    container_name: seerr
    depends_on:
      gluetun:
        condition: service_healthy  # Needs gluetun to reach Sonarr/Radarr
        restart: true
    ports:
      - "5055:5055"  # Local network access (all interfaces)
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - LOG_LEVEL=info
      - TZ=${TZ}
      - PORT=5055
    networks:
      arr-stack:
        ipv4_address: 172.20.0.8
    volumes:
      - ${CONFIG_ROOT}/seerr:/app/config
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 20s

  # ═══════════════════════════════════════════════════════════════════════════
  # BAZARR - Subtitle manager. Automatically downloads subtitles.
  # Access: bazarr.mediastack.lab | bazarr.yourdomain.com | NAS_IP:6767
  # ═══════════════════════════════════════════════════════════════════════════
  bazarr:
    image: lscr.io/linuxserver/bazarr:1.5.5
    container_name: bazarr
    depends_on:
      gluetun:
        condition: service_healthy  # Needs gluetun to reach Sonarr/Radarr
        restart: true
    ports:
      - "6767:6767"  # Local network access
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.9
    volumes:
      - ${CONFIG_ROOT}/bazarr:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/tv:/tv
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/"]
      interval: 3m
      timeout: 10s
      retries: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # FLARESOLVERR - Cloudflare bypass. Helps Prowlarr access protected sites.
  # Runs behind Gluetun VPN so solved cookies match Prowlarr's exit IP.
  # No web UI. Used internally by Prowlarr at localhost:8191
  # ═══════════════════════════════════════════════════════════════════════════
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.4.6
    container_name: flaresolverr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      # Actually test Chrome by making a solve request (catches Chrome crashes)
      test: ["CMD", "curl", "-sf", "-X", "POST", "-H", "Content-Type: application/json",
             "-d", "{\"cmd\":\"request.get\",\"url\":\"http://localhost:8191/\",\"maxTimeout\":30000}",
             "http://localhost:8191/v1"]
      interval: 10m
      timeout: 60s
      retries: 2
      start_period: 60s
  
  # ═══════════════════════════════════════════════════════════════════════════
  # LIDARR - Music manager. Automatically downloads music.
  # Access: lidarr.mediastack.lab | lidarr.yourdomain.com | NAS_IP:8686
  # ═══════════════════════════════════════════════════════════════════════════
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/lidarr:/config
      - ${MEDIA_ROOT}:/data  # Same mount as qBittorrent for hardlinks
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8686/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # LazyLibrarian - Ebook & Audiobook manager. Automatically downloads books.
  # Access: lazylibrarian.mediastack.lab | lazylibrarian.yourdomain.com | NAS_IP:5299
  # ═══════════════════════════════════════════════════════════════════════════
  lazylibrarian:
    build:
      dockerfile: Dockerfile-lazylibrarian
      context: .
    #image: lscr.io/linuxserver/lazylibrarian:latest
    container_name: lazylibrarian
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      # - DOCKER_MODS=linuxserver/mods:universal-calibre|linuxserver/mods:lazylibrarian-ffmpeg
    volumes:
      - ${CONFIG_ROOT}/lazylibrarian:/config
      - ${MEDIA_ROOT}:/data
      - ${MEDIA_ROOT}/scripts/lazylibrarian:/home/scripts:rw
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:5299/ && curl -sf http://www.google.com/"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # Calibre Web - Automated - Ebook Library Web UI
  # Access: calibre-web.mediastack.lab | calibre-web.yourdomain.com | NAS_IP:8083
  # ═══════════════════════════════════════════════════════════════════════════
  calibre-web:
    image: crocodilestick/calibre-web-automated:latest
    container_name: calibre-web
    depends_on:
      gluetun:
        condition: service_healthy  # Needs gluetun to reach LazyLibrarian
        restart: true
    networks:
      arr-stack:
        ipv4_address: 172.20.0.10
    ports:
      - "8083:8083"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/calibre-web:/config
      - ${MEDIA_ROOT}/books:/calibre-library
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/"]
      interval: 3m
      timeout: 10s
      retries: 2

