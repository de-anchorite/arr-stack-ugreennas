# Local .mediastack.lab domain routing (port-free access)
#
# How it works:
# 1. Pi-hole DNS resolves *.mediastack.lab → TRAEFIK_LAN_IP (macvlan, e.g. 10.10.0.11)
# 2. Browser requests http://sonarr.mediastack.lab → Traefik on port 80 (macvlan IP)
# 3. Traefik matches Host header → routes to correct service:port
#
# Result: http://sonarr.mediastack.lab instead of http://10.10.0.10:8989
#
# Note: Requires Traefik macvlan setup (see docs/LOCAL-DNS.md)

http:
  routers:
    # === Media Services ===
    plex-lan:
      rule: "Host(`plex.mediastack.lab`)"
      entryPoints: [web]
      service: plex-lan

    seerr-lan:
      rule: "Host(`seerr.mediastack.lab`)"
      entryPoints: [web]
      service: seerr-lan

    calibre-lan:
      rule: "Host(`calibre.mediastack.lab`)"
      entryPoints: [web]
      service: calibre-lan

    # Legacy redirects (jellyseerr/jellyseer → seerr)
    jellyseerr-lan:
      rule: "Host(`jellyseerr.mediastack.lab`)"
      entryPoints: [web]
      middlewares: [jellyseerr-redirect]
      service: seerr-lan

    jellyseer-lan:
      rule: "Host(`jellyseer.mediastack.lab`)"
      entryPoints: [web]
      middlewares: [jellyseerr-redirect]
      service: seerr-lan

    # === *arr Stack (VPN-protected via Gluetun) ===
    sonarr-lan:
      rule: "Host(`sonarr.mediastack.lab`)"
      entryPoints: [web]
      service: sonarr-lan

    radarr-lan:
      rule: "Host(`radarr.mediastack.lab`)"
      entryPoints: [web]
      service: radarr-lan

    prowlarr-lan:
      rule: "Host(`prowlarr.mediastack.lab`)"
      entryPoints: [web]
      service: prowlarr-lan

    bazarr-lan:
      rule: "Host(`bazarr.mediastack.lab`)"
      entryPoints: [web]
      service: bazarr-lan

    lidarr-lan:
      rule: "Host(`lidarr.mediastack.lab`)"
      entryPoints: [web]
      service: lidarr-lan

    lazylibrarian-lan:
      rule: "Host(`lazylibrarian.mediastack.lab`)"
      entryPoints: [web]
      service: lazylibrarian-lan

    # === Download Clients ===
    qbit-lan:
      rule: "Host(`qbit.mediastack.lab`)"
      entryPoints: [web]
      service: qbit-lan

    # === Infrastructure ===
    traefik-lan:
      rule: "Host(`traefik.mediastack.lab`)"
      entryPoints: [web]
      service: api@internal

    # === Utilities ===
    uptime-lan:
      rule: "Host(`uptime.mediastack.lab`)"
      entryPoints: [web]
      service: uptime-lan

    duc-lan:
      rule: "Host(`duc.mediastack.lab`)"
      entryPoints: [web]
      service: duc-lan

    beszel-lan:
      rule: "Host(`beszel.mediastack.lab`)"
      entryPoints: [web]
      service: beszel-lan

    whoami-lan:
      rule: "Host(`whoami.mediastack.lab`)"
      entryPoints: [web]
      middlewares: [plex-host-override] # Host header override for testing
      service: whoami-lan

  middlewares:
    jellyseerr-redirect:
      redirectRegex:
        regex: "^http://jellyseer{1,2}[.]mediastack[.]lab(.*)"
        replacement: "http://seerr.mediastack.lab${1}"
        permanent: true

  services:
    # === Media Services ===
    plex-lan:
      loadBalancer:
        servers:
          - url: "http://192.168.1.102:32400"

    calibre-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.10:8083"

    seerr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.8:5055"

    # === *arr Stack (via Gluetun at 172.20.0.3) ===
    sonarr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:8989"

    radarr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:7878"

    prowlarr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:9696"

    lidarr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:8686"

    lazylibrarian-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:5299"

    bazarr-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.9:6767"

    # === Download Clients (via Gluetun) ===
    qbit-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:8085"

    sabnzbd-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.3:8080"

    # === Utilities ===
    uptime-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.13:3001"

    duc-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.14:80"

    beszel-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.15:8090"

    whoami-lan:
      loadBalancer:
        servers:
          - url: "http://172.20.0.16:80"
          
